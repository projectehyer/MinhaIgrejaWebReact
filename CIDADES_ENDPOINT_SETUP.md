# Endpoint de Cidades - Setup e ImplementaÃ§Ã£o

## âœ… IMPLEMENTAÃ‡ÃƒO CONCLUÃDA

A funcionalidade de cidades foi **implementada com sucesso** e estÃ¡ consumindo o endpoint do Supabase.

## ðŸ“‹ VisÃ£o Geral

Este documento explica como implementar o endpoint de cidades no Supabase para integrar com o formulÃ¡rio de igrejas.

## ðŸ—„ï¸ Estrutura da Tabela de Cidades

### SQL para Criar a Tabela

```sql
-- Tabela de estados (se ainda nÃ£o existir)
CREATE TABLE IF NOT EXISTS public.estados (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nome character varying NOT NULL,
  uf character varying(2) NOT NULL UNIQUE
);

-- Tabela de cidades
CREATE TABLE public.cidades (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nome character varying NOT NULL,
  id_uf bigint NOT NULL REFERENCES public.estados(id),
  created_at timestamp with time zone DEFAULT now()
);

-- Ãndices para performance
CREATE INDEX idx_cidades_uf ON public.cidades(id_uf);
CREATE INDEX idx_cidades_nome ON public.cidades(nome);
```

### Inserir Estados (se necessÃ¡rio)

```sql
INSERT INTO public.estados (nome, uf) VALUES
('Acre', 'AC'),
('Alagoas', 'AL'),
('AmapÃ¡', 'AP'),
('Amazonas', 'AM'),
('Bahia', 'BA'),
('CearÃ¡', 'CE'),
('Distrito Federal', 'DF'),
('EspÃ­rito Santo', 'ES'),
('GoiÃ¡s', 'GO'),
('MaranhÃ£o', 'MA'),
('Mato Grosso', 'MT'),
('Mato Grosso do Sul', 'MS'),
('Minas Gerais', 'MG'),
('ParÃ¡', 'PA'),
('ParaÃ­ba', 'PB'),
('ParanÃ¡', 'PR'),
('Pernambuco', 'PE'),
('PiauÃ­', 'PI'),
('Rio de Janeiro', 'RJ'),
('Rio Grande do Norte', 'RN'),
('Rio Grande do Sul', 'RS'),
('RondÃ´nia', 'RO'),
('Roraima', 'RR'),
('Santa Catarina', 'SC'),
('SÃ£o Paulo', 'SP'),
('Sergipe', 'SE'),
('Tocantins', 'TO');
```

## ðŸ”§ ConfiguraÃ§Ã£o de SeguranÃ§a (RLS)

```sql
-- Habilitar RLS nas tabelas
ALTER TABLE public.cidades ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.estados ENABLE ROW LEVEL SECURITY;

-- PolÃ­ticas para cidades
CREATE POLICY "UsuÃ¡rios autenticados podem ler cidades" ON public.cidades
FOR SELECT USING (auth.role() = 'authenticated');

-- PolÃ­ticas para estados
CREATE POLICY "UsuÃ¡rios autenticados podem ler estados" ON public.estados
FOR SELECT USING (auth.role() = 'authenticated');
```

## ðŸ”„ Endpoints DisponÃ­veis

### 1. Buscar Cidades por Estado
```
GET /rest/v1/cidades?id_uf=eq.{id_estado}&select=*
```

**Exemplo:**
```javascript
const res = await api.get(
  `${SUPABASE_URL}/rest/v1/cidades?id_uf=eq.25&select=*`,
  {
    headers: {
      apikey: SUPABASE_API_KEY,
      Authorization: `Bearer ${SUPABASE_API_KEY}`,
    },
  }
);
```

### 2. Buscar Todas as Cidades
```
GET /rest/v1/cidades?select=*
```

### 3. Buscar Cidade por ID
```
GET /rest/v1/cidades?id=eq.{id_cidade}&select=*
```

## ðŸ› ï¸ ImplementaÃ§Ã£o no CÃ³digo

### âœ… 1. FunÃ§Ã£o fetchCidades Implementada

```javascript
// Em src/components/content/IgrejaForm.jsx
const fetchCidades = async (idUf) => {
  setLoadingCidades(true);
  try {
    const SUPABASE_URL = process.env.REACT_APP_SUPABASE_API_BASE_URL;
    const SUPABASE_API_KEY = process.env.REACT_APP_SUPABASE_API_KEY;
    
    const res = await api.get(`${SUPABASE_URL}/rest/v1/cidades?id_uf=eq.${idUf}&select=*`, {
      headers: {
        apikey: SUPABASE_API_KEY,
        Authorization: `Bearer ${SUPABASE_API_KEY}`,
      },
    });
    setCidades(res.data);
  } catch (error) {
    console.error('Erro ao buscar cidades:', error);
    setCidades([]);
  } finally {
    setLoadingCidades(false);
  }
};
```

### âœ… 2. Trigger AutomÃ¡tico Implementado

```javascript
const handleChange = (e) => {
  const { name, value } = e.target;
  setFormData({ ...formData, [name]: value });
  
  // Se o estado foi alterado, limpar a cidade e carregar novas cidades
  if (name === 'id_uf') {
    setFormData(prev => ({ ...prev, [name]: value, id_cidade: '' }));
    if (value) {
      fetchCidades(value);
    } else {
      setCidades([]);
    }
  }
};
```

## ðŸ“Š Dados de Exemplo

### Inserir Cidades de Exemplo

```sql
-- Exemplo para SÃ£o Paulo (id_uf = 25)
INSERT INTO public.cidades (nome, id_uf) VALUES
('SÃ£o Paulo', 25),
('Guarulhos', 25),
('Campinas', 25),
('SÃ£o Bernardo do Campo', 25),
('Santo AndrÃ©', 25),
('Osasco', 25),
('RibeirÃ£o Preto', 25),
('Sorocaba', 25),
('MauÃ¡', 25),
('CarapicuÃ­ba', 25);

-- Exemplo para Rio de Janeiro (id_uf = 19)
INSERT INTO public.cidades (nome, id_uf) VALUES
('Rio de Janeiro', 19),
('SÃ£o GonÃ§alo', 19),
('Duque de Caxias', 19),
('Nova IguaÃ§u', 19),
('NiterÃ³i', 19),
('Belford Roxo', 19),
('SÃ£o JoÃ£o de Meriti', 19),
('PetrÃ³polis', 19),
('Campos dos Goytacazes', 19),
('Volta Redonda', 19);
```

## ðŸŽ¯ Funcionalidades Implementadas

### âœ… Comportamento Atual
- âœ… Dropdown de estados funcional
- âœ… **Busca real de cidades da API**
- âœ… Loading state durante carregamento
- âœ… ValidaÃ§Ã£o de campos obrigatÃ³rios
- âœ… Limpeza automÃ¡tica da cidade quando estado muda
- âœ… Tratamento de erros adequado
- âœ… DependÃªncia correta entre estado e cidade

### âœ… Implementado
- âœ… Criar tabela `cidades` no Supabase
- âœ… Configurar polÃ­ticas RLS
- âœ… Inserir dados de cidades
- âœ… Substituir simulaÃ§Ã£o pela API real
- âœ… Usar variÃ¡veis de ambiente corretas

## ðŸ§ª Como Testar

1. **Acesse o formulÃ¡rio de igrejas**
2. **Selecione um estado** no dropdown
3. **Observe o dropdown de cidades** - deve mostrar "Carregando cidades..."
4. **Verifique se as cidades carregam** corretamente
5. **Teste trocar de estado** - a cidade deve ser limpa e recarregada

## ðŸ”— Endpoint Utilizado

```
GET /rest/v1/cidades?id_uf=eq.{id_estado}&select=*
```

**Headers:**
- `apikey: SUPABASE_API_KEY`
- `Authorization: Bearer SUPABASE_API_KEY`

## ðŸš€ PrÃ³ximos Passos

1. **Execute o SQL** para criar as tabelas
2. **Configure as polÃ­ticas RLS**
3. **Insira dados de cidades** (pode usar API externa ou dados do IBGE)
4. **Atualize o cÃ³digo** para usar a API real
5. **Teste a funcionalidade**

## ðŸ“š Recursos Adicionais

### API do IBGE para Cidades
VocÃª pode usar a API do IBGE para obter dados reais de cidades:

```
GET https://servicodados.ibge.gov.br/api/v1/localidades/estados/{UF}/municipios
```

### Script para Popular Cidades
```javascript
// Script para popular cidades usando API do IBGE
const popularCidades = async (uf) => {
  const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
  const municipios = await response.json();
  
  // Inserir no Supabase
  for (const municipio of municipios) {
    await supabase.from('cidades').insert({
      nome: municipio.nome,
      id_uf: municipio.microrregiao.mesorregiao.UF.id
    });
  }
};
``` 