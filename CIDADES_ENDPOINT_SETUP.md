# Endpoint de Cidades - Setup e Implementação

## ✅ IMPLEMENTAÇÃO CONCLUÍDA

A funcionalidade de cidades foi **implementada com sucesso** e está consumindo o endpoint do Supabase.

## 📋 Visão Geral

Este documento explica como implementar o endpoint de cidades no Supabase para integrar com o formulário de igrejas.

## 🗄️ Estrutura da Tabela de Cidades

### SQL para Criar a Tabela

```sql
-- Tabela de estados (se ainda não existir)
CREATE TABLE IF NOT EXISTS public.estados (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nome character varying NOT NULL,
  uf character varying(2) NOT NULL UNIQUE
);

-- Tabela de cidades
CREATE TABLE public.cidades (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nome character varying NOT NULL,
  id_uf bigint NOT NULL REFERENCES public.estados(id),
  created_at timestamp with time zone DEFAULT now()
);

-- Índices para performance
CREATE INDEX idx_cidades_uf ON public.cidades(id_uf);
CREATE INDEX idx_cidades_nome ON public.cidades(nome);
```

### Inserir Estados (se necessário)

```sql
INSERT INTO public.estados (nome, uf) VALUES
('Acre', 'AC'),
('Alagoas', 'AL'),
('Amapá', 'AP'),
('Amazonas', 'AM'),
('Bahia', 'BA'),
('Ceará', 'CE'),
('Distrito Federal', 'DF'),
('Espírito Santo', 'ES'),
('Goiás', 'GO'),
('Maranhão', 'MA'),
('Mato Grosso', 'MT'),
('Mato Grosso do Sul', 'MS'),
('Minas Gerais', 'MG'),
('Pará', 'PA'),
('Paraíba', 'PB'),
('Paraná', 'PR'),
('Pernambuco', 'PE'),
('Piauí', 'PI'),
('Rio de Janeiro', 'RJ'),
('Rio Grande do Norte', 'RN'),
('Rio Grande do Sul', 'RS'),
('Rondônia', 'RO'),
('Roraima', 'RR'),
('Santa Catarina', 'SC'),
('São Paulo', 'SP'),
('Sergipe', 'SE'),
('Tocantins', 'TO');
```

## 🔧 Configuração de Segurança (RLS)

```sql
-- Habilitar RLS nas tabelas
ALTER TABLE public.cidades ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.estados ENABLE ROW LEVEL SECURITY;

-- Políticas para cidades
CREATE POLICY "Usuários autenticados podem ler cidades" ON public.cidades
FOR SELECT USING (auth.role() = 'authenticated');

-- Políticas para estados
CREATE POLICY "Usuários autenticados podem ler estados" ON public.estados
FOR SELECT USING (auth.role() = 'authenticated');
```

## 🔄 Endpoints Disponíveis

### 1. Buscar Cidades por Estado
```
GET /rest/v1/cidades?id_uf=eq.{id_estado}&select=*
```

**Exemplo:**
```javascript
const res = await api.get(
  `${SUPABASE_URL}/rest/v1/cidades?id_uf=eq.25&select=*`,
  {
    headers: {
      apikey: SUPABASE_API_KEY,
      Authorization: `Bearer ${SUPABASE_API_KEY}`,
    },
  }
);
```

### 2. Buscar Todas as Cidades
```
GET /rest/v1/cidades?select=*
```

### 3. Buscar Cidade por ID
```
GET /rest/v1/cidades?id=eq.{id_cidade}&select=*
```

## 🛠️ Implementação no Código

### ✅ 1. Função fetchCidades Implementada

```javascript
// Em src/components/content/IgrejaForm.jsx
const fetchCidades = async (idUf) => {
  setLoadingCidades(true);
  try {
    const SUPABASE_URL = process.env.REACT_APP_SUPABASE_API_BASE_URL;
    const SUPABASE_API_KEY = process.env.REACT_APP_SUPABASE_API_KEY;
    
    const res = await api.get(`${SUPABASE_URL}/rest/v1/cidades?id_uf=eq.${idUf}&select=*`, {
      headers: {
        apikey: SUPABASE_API_KEY,
        Authorization: `Bearer ${SUPABASE_API_KEY}`,
      },
    });
    setCidades(res.data);
  } catch (error) {
    console.error('Erro ao buscar cidades:', error);
    setCidades([]);
  } finally {
    setLoadingCidades(false);
  }
};
```

### ✅ 2. Trigger Automático Implementado

```javascript
const handleChange = (e) => {
  const { name, value } = e.target;
  setFormData({ ...formData, [name]: value });
  
  // Se o estado foi alterado, limpar a cidade e carregar novas cidades
  if (name === 'id_uf') {
    setFormData(prev => ({ ...prev, [name]: value, id_cidade: '' }));
    if (value) {
      fetchCidades(value);
    } else {
      setCidades([]);
    }
  }
};
```

## 📊 Dados de Exemplo

### Inserir Cidades de Exemplo

```sql
-- Exemplo para São Paulo (id_uf = 25)
INSERT INTO public.cidades (nome, id_uf) VALUES
('São Paulo', 25),
('Guarulhos', 25),
('Campinas', 25),
('São Bernardo do Campo', 25),
('Santo André', 25),
('Osasco', 25),
('Ribeirão Preto', 25),
('Sorocaba', 25),
('Mauá', 25),
('Carapicuíba', 25);

-- Exemplo para Rio de Janeiro (id_uf = 19)
INSERT INTO public.cidades (nome, id_uf) VALUES
('Rio de Janeiro', 19),
('São Gonçalo', 19),
('Duque de Caxias', 19),
('Nova Iguaçu', 19),
('Niterói', 19),
('Belford Roxo', 19),
('São João de Meriti', 19),
('Petrópolis', 19),
('Campos dos Goytacazes', 19),
('Volta Redonda', 19);
```

## 🎯 Funcionalidades Implementadas

### ✅ Comportamento Atual
- ✅ Dropdown de estados funcional
- ✅ **Busca real de cidades da API**
- ✅ Loading state durante carregamento
- ✅ Validação de campos obrigatórios
- ✅ Limpeza automática da cidade quando estado muda
- ✅ Tratamento de erros adequado
- ✅ Dependência correta entre estado e cidade

### ✅ Implementado
- ✅ Criar tabela `cidades` no Supabase
- ✅ Configurar políticas RLS
- ✅ Inserir dados de cidades
- ✅ Substituir simulação pela API real
- ✅ Usar variáveis de ambiente corretas

## 🧪 Como Testar

1. **Acesse o formulário de igrejas**
2. **Selecione um estado** no dropdown
3. **Observe o dropdown de cidades** - deve mostrar "Carregando cidades..."
4. **Verifique se as cidades carregam** corretamente
5. **Teste trocar de estado** - a cidade deve ser limpa e recarregada

## 🔗 Endpoint Utilizado

```
GET /rest/v1/cidades?id_uf=eq.{id_estado}&select=*
```

**Headers:**
- `apikey: SUPABASE_API_KEY`
- `Authorization: Bearer SUPABASE_API_KEY`

## 🚀 Próximos Passos

1. **Execute o SQL** para criar as tabelas
2. **Configure as políticas RLS**
3. **Insira dados de cidades** (pode usar API externa ou dados do IBGE)
4. **Atualize o código** para usar a API real
5. **Teste a funcionalidade**

## 📚 Recursos Adicionais

### API do IBGE para Cidades
Você pode usar a API do IBGE para obter dados reais de cidades:

```
GET https://servicodados.ibge.gov.br/api/v1/localidades/estados/{UF}/municipios
```

### Script para Popular Cidades
```javascript
// Script para popular cidades usando API do IBGE
const popularCidades = async (uf) => {
  const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
  const municipios = await response.json();
  
  // Inserir no Supabase
  for (const municipio of municipios) {
    await supabase.from('cidades').insert({
      nome: municipio.nome,
      id_uf: municipio.microrregiao.mesorregiao.UF.id
    });
  }
};
``` 